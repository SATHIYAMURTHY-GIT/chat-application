<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat App</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
:root {
    --bg-light: #f5f5f5;
    --bg-dark: #1e1e1e;
    --chat-light: #fff;
    --chat-dark: #2c2c2c;
    --text-light: #000;
    --text-dark: #fff;
}

body {
    font-family: Arial, sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: var(--bg-light);
    color: var(--text-light);
    transition: all 0.3s;
}

#themeContainer {
    position: absolute;
    top: 10px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0;
    right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 24px;
}
.slider:before {
    position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
    background-color: white; transition: 0.4s; border-radius: 50%;
}
input:checked + .slider { background-color: #007bff; }
input:checked + .slider:before { transform: translateX(26px); }

#chat {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    margin-top: 50px;
}

.message {
    max-width: 60%;
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 15px;
    word-wrap: break-word;
    display: inline-block;
}

.message .username {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
}

.message.self { align-self: flex-end; border-bottom-right-radius: 0; }
.message.other { align-self: flex-start; border-bottom-left-radius: 0; }

#input-area {
    display: flex;
    padding: 10px;
    background-color: var(--chat-light);
    align-items: center;
}

#username, #msg {
    padding: 10px 15px;
    border: 1px solid #ccc;
    border-radius: 20px;
    outline: none;
    font-size: 16px;
}
#username { width: 120px; margin-right: 10px; }
#msg { flex-grow: 1; margin-right: 10px; }

#sendBtn {
    background: #007bff;
    border: none;
    color: white;
    padding: 10px 16px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
}
#sendBtn:hover { background: #0056b3; }

.message img {
    max-width: 100%;
    margin-top: 5px;
    border-radius: 10px;
}
</style>
</head>
<body>
<div id="themeContainer">
    <label>Dark Mode</label>
    <label class="switch">
        <input type="checkbox" id="themeToggle">
        <span class="slider"></span>
    </label>
</div>

<div id="chat"></div>

<div id="input-area">
    <input id="username" autocomplete="off" placeholder="Name">
    <input id="msg" autocomplete="off" placeholder="Message">
    <button id="sendBtn" title="Send">&#9658;</button>
</div>

<script>
const socket = io("http://127.0.0.1:5000");  // Explicit server URL
const chat = document.getElementById('chat');
const usernameInput = document.getElementById('username');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const themeToggle = document.getElementById('themeToggle');

const userColors = {};
const colors = ["#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe"];

function getUserColor(username){
    if(!userColors[username]){
        userColors[username] = colors[Math.floor(Math.random()*colors.length)];
    }
    return userColors[username];
}

function getContrastYIQ(hexcolor){
    hexcolor = hexcolor.replace("#", "");
    const r = parseInt(hexcolor.substr(0,2),16);
    const g = parseInt(hexcolor.substr(2,2),16);
    const b = parseInt(hexcolor.substr(4,2),16);
    const yiq = ((r*299)+(g*587)+(b*114))/1000;
    return (yiq >= 128) ? 'black' : 'white';
}

function isImageURL(url){
    return /\.(jpeg|jpg|gif|png|webp)$/i.test(url);
}

function addMessage(data){
    const div = document.createElement('div');
    div.classList.add('message');
    const user = data.user || 'Anonymous';
    div.classList.add(user === usernameInput.value.trim() ? 'self' : 'other');

    const bgColor = getUserColor(user);
    div.style.backgroundColor = bgColor;
    div.style.color = getContrastYIQ(bgColor);

    const name = document.createElement('span');
    name.classList.add('username');
    name.textContent = user;
    div.appendChild(name);

    if(isImageURL(data.msg)){
        const img = document.createElement('img');
        img.src = data.msg;
        div.appendChild(img);
    } else {
        const text = document.createElement('span');
        text.textContent = data.msg;
        div.appendChild(text);
    }

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

// Receive messages
socket.on('message', addMessage);

// Send message
function sendMessage(){
    const user = usernameInput.value.trim() || 'Anonymous';
    const text = msgInput.value.trim();
    if(text !== ''){
        socket.send({ user: user, msg: text });
        msgInput.value = '';
    }
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });

// Dark/light mode
themeToggle.addEventListener('change', () => {
    const darkMode = themeToggle.checked;
    document.body.style.backgroundColor = darkMode ? 'var(--bg-dark)' : 'var(--bg-light)';
    document.body.style.color = darkMode ? 'var(--text-dark)' : 'var(--text-light)';
    document.getElementById('input-area').style.backgroundColor = darkMode ? 'var(--chat-dark)' : 'var(--chat-light)';
});
</script>
</body>
</html>
